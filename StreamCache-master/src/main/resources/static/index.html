<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>StreamCache - M√ºhendislik Performans Analizi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #141414; color: white; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        .navbar { background-color: #000; border-bottom: 1px solid #333; padding: 15px; }
        .nav-link { color: #aaa !important; cursor: pointer; margin-right: 15px; transition: color 0.3s; }
        .nav-link.active { color: white !important; font-weight: bold; }
        .logo { color: #e50914; font-size: 28px; font-weight: bold; text-decoration: none; margin-right: 30px; }

        .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; padding: 30px; }
        .movie-card { background: #1f1f1f; border-radius: 8px; overflow: hidden; transition: transform 0.3s; cursor: pointer; position: relative; border: 1px solid #333; }
        .movie-card:hover { transform: scale(1.05); z-index: 10; border-color: #aaa; }

        .poster-container { width: 100%; height: 300px; background-color: #333; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .movie-poster { width: 100%; height: 100%; object-fit: cover; }
        .poster-fallback { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 20px; font-weight: bold; padding: 10px; color: white; }

        .movie-info { padding: 15px; }
        .movie-title { font-size: 16px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }

        /* ƒ∞ZLENME SAYISI STƒ∞Lƒ∞ */
        .view-count { color: #b3b3b3; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .view-count i { color: #e50914; font-size: 0.75rem; }

        .badge-cache { position: absolute; top: 10px; right: 10px; background: #e50914; color: white; font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: bold; z-index: 2; }

        .admin-panel { background: #f0f2f5; color: black; padding: 30px; border-radius: 10px; margin-top: 20px; }
        .log-box { height: 250px; overflow-y: scroll; background: #1e1e1e; color: #00ff41; padding: 15px; font-family: 'Consolas', monospace; border-radius: 5px; font-size: 12px; }
        .log-item { margin-bottom: 5px; border-bottom: 1px solid #333; }
        .chart-container { position: relative; height: 250px; width: 100%; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="logo" href="#">StreamCache</a>
        <div class="d-flex">
            <a class="nav-link active" onclick="switchTab('user', this)">Anasayfa</a>
            <a class="nav-link" onclick="switchTab('admin', this)">Admin Paneli</a>
        </div>
    </div>
</nav>

<div id="userView" class="container-fluid">
    <div class="row">
        <div class="col-md-2 p-4" style="border-right: 1px solid #333; min-height: 80vh;">
            <h5 class="mb-4">Kategoriler</h5>
            <div class="list-group list-group-flush bg-transparent">
                <button onclick="filterByGenre('T√ºm√º')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üé¨ Ana Sayfa</button>
                <button onclick="filterByGenre('Bilim Kurgu')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üöÄ Bilim Kurgu</button>
                <button onclick="filterByGenre('Aksiyon')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üí• Aksiyon</button>
                <button onclick="filterByGenre('Korku')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üëª Korku</button>
                <button onclick="filterByGenre('Animasyon')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">ü¶Ñ Animasyon</button>
                <button onclick="filterByGenre('Romantik')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üíñ Romantik</button>
                <button onclick="filterByGenre('Komedi')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üòÇ Komedi</button>
                <button onclick="filterByGenre('Dram')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">üé≠ Dram</button>
                <button onclick="filterByGenre('Su√ß')" class="list-group-item list-group-item-action bg-transparent text-white border-0 py-2">‚öñÔ∏è Su√ß</button>
            </div>
        </div>

        <div class="col-md-10 p-4">
            <h3 id="genreTitle">Pop√ºler ƒ∞√ßerikler</h3>
            <p class="text-muted">En √ßok izlenen filmler algoritma ile otomatik olarak √∂n sƒ±ralara gelir.</p>
            <div class="movie-grid" id="movieGrid"></div>
        </div>
    </div>
</div>

<div id="adminView" class="container" style="display: none;">
    <div class="admin-panel shadow">
        <h2 class="text-center mb-4">üîß Sistem Performans Analizi</h2>
        <div class="row mb-4 text-center">
            <div class="col-md-4">
                <div class="card p-3 border-danger shadow-sm">
                    <h6 class="text-muted">Ort. DB Eri≈üimi</h6>
                    <h3 class="text-danger fw-bold">~25.000 ¬µs</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-success shadow-sm">
                    <h6 class="text-muted">Ort. Cache Eri≈üimi</h6>
                    <h3 class="text-success fw-bold">~5.000 ¬µs</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 bg-danger text-white shadow-sm">
                    <h6>Verimlilik Artƒ±≈üƒ±</h6>
                    <h3 id="boostText" class="fw-bold">1.0x</h3>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6"><div class="card p-3 shadow-sm h-100"><h6 class="text-primary fw-bold text-center">Hit/Miss Daƒüƒ±lƒ±mƒ±</h6><div class="chart-container"><canvas id="missRateChart"></canvas></div></div></div>
            <div class="col-md-6"><div class="card p-3 shadow-sm h-100"><h6 class="text-danger fw-bold text-center">‚ö° Latency Trace (Anlƒ±k)</h6><div class="chart-container"><canvas id="latencyChart"></canvas></div></div></div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card p-3 shadow-sm">
                    <h6 class="text-dark fw-bold">RAM (Active Cache - Kapasite: 5)</h6>
                    <ul id="ramList" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3">
            <div class="card-header bg-dark text-white">Canlƒ± Sistem Loglarƒ±</div>
            <div class="log-box" id="systemLogs"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="movieModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered text-dark">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-5"><img id="modalImg" class="img-fluid rounded shadow-sm" style="height:200px; object-fit:cover;"></div>
                    <div class="col-md-7"><h6>√ñzet</h6><p id="modalDesc" class="small"></p><hr><div id="modalStatus"></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let latencyData = Array(10).fill(0);
    let currentGenre = "T√ºm√º";

    // Grafikler
    const ctxLatency = document.getElementById('latencyChart').getContext('2d');
    const latencyChart = new Chart(ctxLatency, {
        type: 'line',
        data: { labels: Array(10).fill(''), datasets: [{ data: latencyData, borderColor: '#e50914', backgroundColor: 'rgba(229, 9, 20, 0.1)', fill: true, tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    const ctxMiss = document.getElementById('missRateChart').getContext('2d');
    const missRateChart = new Chart(ctxMiss, {
        type: 'doughnut',
        data: { labels: ['Hit', 'Miss'], datasets: [{ data: [0, 0], backgroundColor: ['#28a745', '#dc3545'] }] },
        options: { responsive: true, maintainAspectRatio: false }
    });

    function switchTab(tab, element) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('userView').style.display = tab === 'user' ? 'block' : 'none';
        document.getElementById('adminView').style.display = tab === 'admin' ? 'block' : 'none';
        if(tab === 'admin') updateAdminStats();
    }

    async function watchMovie(id) {
        const response = await fetch('/api/movies/' + id);
        const data = await response.json();

        latencyData.shift();
        latencyData.push(data.duration);
        latencyChart.update();

        const boost = (25000 / data.duration).toFixed(1);
        document.getElementById('boostText').innerText = boost + "x";

        document.getElementById('modalTitle').innerText = data.movie.title;
        document.getElementById('modalDesc').innerText = data.movie.description;
        document.getElementById('modalImg').src = data.movie.imageUrl;

        const statusDiv = document.getElementById('modalStatus');
        let predictionNote = data.cacheHit ? "" : `<div class="mt-2 small text-primary fw-bold italic">üîÆ TAHMƒ∞NLEME: Bu t√ºre benzer i√ßerikler RAM'e hazƒ±rlandƒ±!</div>`;
        statusDiv.innerHTML = `<div class="alert ${data.cacheHit ? 'alert-success' : 'alert-danger'} py-2 mb-0"><strong>${data.cacheHit ? 'üî• CACHE HIT!' : 'üê¢ CACHE MISS!'}</strong><br>S√ºre: ${data.duration} ¬µs</div>${predictionNote}`;

        logToAdmin(`> ${data.cacheHit ? 'HIT' : 'MISS'}: '${data.movie.title}' | S√ºre: ${data.duration}¬µs`, data.cacheHit ? 'text-success' : 'text-danger');

        new bootstrap.Modal(document.getElementById('movieModal')).show();
        loadMovies(); // ƒ∞zlenme sayƒ±sƒ± g√ºncellendiƒüi i√ßin listeyi tazele
    }

    function filterByGenre(genre) {
        currentGenre = genre;
        document.getElementById('genreTitle').innerText = genre === "T√ºm√º" ? "Pop√ºler ƒ∞√ßerikler" : genre;
        loadMovies();
    }

    async function loadMovies() {
        try {
            const response = await fetch('/api/movies/list');
            let movies = await response.json();

            if (currentGenre !== "T√ºm√º") movies = movies.filter(m => m.genre === currentGenre);
            movies.sort((a, b) => b.accessCount - a.accessCount);

            const cachedIds = (await (await fetch('/api/cache-content')).json()).map(m => m.id);

            const grid = document.getElementById('movieGrid');
            grid.innerHTML = movies.map(movie => `
                <div class="movie-card" onclick="watchMovie(${movie.id})">
                    ${cachedIds.includes(movie.id) ? '<span class="badge-cache">‚ö° CACHED</span>' : ''}
                    <div class="poster-container">
                        <img src="${movie.imageUrl}" class="movie-poster" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="poster-fallback" style="background:${stringToColor(movie.title)}; display:none;">${movie.title}</div>
                    </div>
                    <div class="movie-info">
                        <div class="movie-title">${movie.title}</div>
                        <div class="view-count">
                            <i class="fa-solid fa-eye"></i> ${movie.accessCount} izlenme
                        </div>
                    </div>
                </div>`).join('');

            if(movies.length === 0) grid.innerHTML = `<div class="text-center w-100 mt-5 text-muted">Hen√ºz film bulunmuyor.</div>`;
        } catch (e) { console.error("Hata:", e); }
    }

    async function updateAdminStats() {
        const stats = await (await fetch('/api/stats')).json();
        missRateChart.data.datasets[0].data = [stats.cacheHits, stats.cacheMisses];
        missRateChart.update();

        const ramMovies = await (await fetch('/api/cache-content')).json();
        document.getElementById('ramList').innerHTML = ramMovies.map(m => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${m.title} <span class="badge bg-primary rounded-pill">${m.accessCount}</span>
            </li>`).join('') || "√ñnbellek Bo≈ü";
    }

    function logToAdmin(msg, cls) {
        const box = document.getElementById('systemLogs');
        box.innerHTML = `<div class="log-item ${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + box.innerHTML;
    }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        return `linear-gradient(45deg, hsl(${Math.abs(hash % 360)}, 70%, 40%), #141414)`;
    }

    loadMovies();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>